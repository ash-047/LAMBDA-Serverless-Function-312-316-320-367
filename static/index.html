<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serverless Function Platform</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .left-panel, .right-panel {
            flex: 1;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .function-list {
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .function-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .function-item:hover {
            background-color: #f0f0f0;
        }
        .function-item.selected {
            background-color: #e0f0ff;
        }
        textarea {
            width: 100%;
            min-height: 300px;
            font-family: monospace;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
        input, button {
            padding: 8px 12px;
            margin: 8px 0;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.secondary {
            background-color: #2196F3;
        }
        button.secondary:hover {
            background-color: #0b7dda;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
        .language-selector {
            margin-bottom: 15px;
        }
        .code-editor {
            font-family: monospace;
            line-height: 1.5;
        }
        .tabs {
            display: flex;
            margin-bottom: 15px;
        }
        .tab {
            padding: 8px 16px;
            cursor: pointer;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #fff;
            border-bottom: 1px solid #fff;
            margin-bottom: -1px;
            z-index: 1;
        }
        .tab-content {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 0 4px 4px 4px;
        }
        .metrics-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .metrics-summary {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .metric-card {
            flex: 1;
            min-width: 250px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .metrics-detail {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .metrics-table {
            width: 100%;
            border-collapse: collapse;
        }
        .metrics-table th, .metrics-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .metrics-table th {
            background-color: #f0f0f0;
        }
        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .metric-label {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Serverless Function Platform</h1>
    
    <div class="tabs">
        <div class="tab active" id="executionTab" onclick="switchMainTab('execution')">Function Execution</div>
        <div class="tab" id="metricsTab" onclick="switchMainTab('metrics')">Metrics Dashboard</div>
    </div>
    
    <div id="executionPanel" style="display: block;">
        <div class="container">
            <div class="left-panel">
                <h2>Stored Functions</h2>
                <div class="function-list" id="functionList">
                    <!-- Function items will be loaded here -->
                </div>
                
                <h2>Function Code</h2>
                <div class="form-group">
                    <label for="functionName">Function Name:</label>
                    <input type="text" id="functionName" placeholder="My Function">
                </div>
                
                <div class="form-group language-selector">
                    <label>Language:</label>
                    <select id="languageSelect" onchange="changeLanguage()">
                        <option value="python">Python</option>
                        <option value="javascript">JavaScript</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="functionCode">Function Code:</label>
                    <div class="tabs">
                        <div class="tab active" id="pythonTab" onclick="switchTab('python')">Python</div>
                        <div class="tab" id="javascriptTab" onclick="switchTab('javascript')">JavaScript</div>
                    </div>
                    <div class="tab-content">
                        <textarea id="pythonCode" class="code-editor" style="display: block;">def handler(event):
    # Your Python code here
    name = event.get('name', 'World')
    return {'message': f'Hello, {name}!'}</textarea>
                        <textarea id="javascriptCode" class="code-editor" style="display: none;">function handler(event) {
    // Your JavaScript code here
    const name = event.name || 'World';
    return { message: `Hello, ${name}!` };
}

module.exports = { handler };</textarea>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="description">Description:</label>
                    <input type="text" id="description" placeholder="What does this function do?">
                </div>
                
                <div class="form-group">
                    <label for="timeout">Timeout (seconds):</label>
                    <input type="number" id="timeout" value="60" min="1" max="300">
                </div>
                
                <div class="form-group">
                    <label>Runtime:</label>
                    <select id="runtimeSelect">
                        <option value="docker">Docker (Standard)</option>
                        <option value="gvisor">gVisor (Sandboxed)</option>
                    </select>
                </div>
                
                <button onclick="saveFunction()" class="secondary">Save Function</button>
            </div>
            
            <div class="right-panel">
                <h2>Execute Function</h2>
                <div class="form-group">
                    <label for="inputData">Input Data (JSON):</label>
                    <textarea id="inputData" placeholder='{"name": "Your Name"}' style="min-height: 150px">{"name": "Your Name"}</textarea>
                </div>
                
                <button onclick="executeFunction()" id="executeBtn">Execute</button>
                <span id="spinner" class="spinner hidden"></span>
                
                <div id="result">
                    <!-- Execution result will be displayed here -->
                    Results will appear here after execution
                </div>
            </div>
        </div>
    </div>
    
    <div id="metricsPanel" style="display: none;">
        <h2>Function Execution Metrics</h2>
        
        <div class="metrics-container">
            <div class="metrics-summary">
                <div class="metric-card">
                    <h3>Overall Statistics</h3>
                    <div id="overallStats">Loading...</div>
                </div>
                
                <div class="metric-card">
                    <h3>Performance by Runtime</h3>
                    <div id="runtimeStats">Loading...</div>
                </div>
                
                <div class="metric-card">
                    <h3>Performance by Language</h3>
                    <div id="languageStats">Loading...</div>
                </div>
            </div>
            
            <div class="metrics-detail">
                <h3>Recent Executions</h3>
                <div id="recentExecutions">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let selectedFunctionId = null;
        let currentLanguage = 'python';
        
        window.onload = function() {
            loadFunctions();
        };
        
        function switchTab(language) {
            document.getElementById('pythonTab').classList.toggle('active', language === 'python');
            document.getElementById('javascriptTab').classList.toggle('active', language === 'javascript');
            
            document.getElementById('pythonCode').style.display = language === 'python' ? 'block' : 'none';
            document.getElementById('javascriptCode').style.display = language === 'javascript' ? 'block' : 'none';
            
            document.getElementById('languageSelect').value = language;
            
            currentLanguage = language;
        }
        
        function changeLanguage() {
            const language = document.getElementById('languageSelect').value;
            switchTab(language);
        }
        
        async function loadFunctions() {
            try {
                const response = await fetch(`${API_URL}/functions`);
                if (response.ok) {
                    const functions = await response.json();
                    const functionList = document.getElementById('functionList');
                    
                    if (functions.length === 0) {
                        functionList.innerHTML = '<div class="function-item">No functions stored yet</div>';
                        return;
                    }
                    
                    functionList.innerHTML = '';
                    functions.forEach(func => {
                        const item = document.createElement('div');
                        item.className = 'function-item';
                        item.textContent = func.name;
                        item.dataset.id = func.id;
                        item.addEventListener('click', () => selectFunction(func.id));
                        functionList.appendChild(item);
                    });
                }
            } catch (error) {
                console.error('Error loading functions:', error);
            }
        }
        
        async function selectFunction(functionId) {
            try {
                const response = await fetch(`${API_URL}/functions/${functionId}`);
                if (response.ok) {
                    const func = await response.json();
                    
                    document.getElementById('functionName').value = func.name;
                    document.getElementById('description').value = func.description || '';
                    document.getElementById('timeout').value = func.timeout || 60;
                    
                    const language = func.language || 'python';
                    document.getElementById('languageSelect').value = language;
                    
                    if (language === 'javascript') {
                        document.getElementById('javascriptCode').value = func.code;
                    } else {
                        document.getElementById('pythonCode').value = func.code;
                    }
                    
                    switchTab(language);
                    
                    selectedFunctionId = functionId;
                    
                    document.querySelectorAll('.function-item').forEach(item => {
                        if (item.dataset.id === functionId) {
                            item.classList.add('selected');
                        } else {
                            item.classList.remove('selected');
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading function details:', error);
            }
        }
        
        async function saveFunction() {
            const name = document.getElementById('functionName').value;
            const language = document.getElementById('languageSelect').value;
            const code = language === 'javascript' ? 
                document.getElementById('javascriptCode').value : 
                document.getElementById('pythonCode').value;
            const description = document.getElementById('description').value;
            const timeout = parseInt(document.getElementById('timeout').value, 10);
            
            if (!name || !code) {
                alert('Function name and code are required');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/functions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        code,
                        function_name: 'handler',
                        description,
                        language,
                        timeout
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`Function "${name}" saved successfully!`);
                    loadFunctions();
                } else {
                    const error = await response.text();
                    alert(`Error saving function: ${error}`);
                }
            } catch (error) {
                console.error('Error saving function:', error);
                alert('Error saving function. See console for details.');
            }
        }
        
        async function executeFunction() {
            const language = document.getElementById('languageSelect').value;
            const runtime = document.getElementById('runtimeSelect').value;
            const code = language === 'javascript' ? 
                document.getElementById('javascriptCode').value : 
                document.getElementById('pythonCode').value;
            let inputData;
            
            try {
                inputData = JSON.parse(document.getElementById('inputData').value);
            } catch (error) {
                alert('Invalid JSON input data');
                return;
            }
            
            document.getElementById('spinner').classList.remove('hidden');
            document.getElementById('executeBtn').disabled = true;
            
            try {
                let response;
                
                if (selectedFunctionId) {
                    response = await fetch(`${API_URL}/functions/${selectedFunctionId}/execute?runtime=${runtime}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(inputData)
                    });
                } else {
                    response = await fetch(`${API_URL}/execute`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            code,
                            function_name: 'handler',
                            input_data: inputData,
                            language,
                            runtime
                        })
                    });
                }
                
                const result = await response.json();
                document.getElementById('result').textContent = JSON.stringify(result, null, 2);
                
                if (result.status === 'success') {
                    document.getElementById('result').style.backgroundColor = '#e9ffe9';
                } else {
                    document.getElementById('result').style.backgroundColor = '#fff0f0';
                }
            } catch (error) {
                console.error('Error executing function:', error);
                document.getElementById('result').textContent = `Error executing function: ${error.message}`;
                document.getElementById('result').style.backgroundColor = '#fff0f0';
            } finally {
                document.getElementById('spinner').classList.add('hidden');
                document.getElementById('executeBtn').disabled = false;
            }
        }
        
        function switchMainTab(tab) {
            document.getElementById('executionTab').classList.toggle('active', tab === 'execution');
            document.getElementById('metricsTab').classList.toggle('active', tab === 'metrics');
            
            document.getElementById('executionPanel').style.display = tab === 'execution' ? 'block' : 'none';
            document.getElementById('metricsPanel').style.display = tab === 'metrics' ? 'block' : 'none';
            
            if (tab === 'metrics') {
                loadMetrics();
            }
        }
        
        async function loadMetrics() {
            try {
                const response = await fetch(`${API_URL}/metrics`);
                if (response.ok) {
                    const metrics = await response.json();
                    displayOverallMetrics(metrics);
                }
                
                const runtimeResponse = await fetch(`${API_URL}/metrics/by-runtime`);
                if (runtimeResponse.ok) {
                    const runtimeMetrics = await runtimeResponse.json();
                    displayRuntimeMetrics(runtimeMetrics);
                }
                
                const languageResponse = await fetch(`${API_URL}/metrics/by-language`);
                if (languageResponse.ok) {
                    const languageMetrics = await languageResponse.json();
                    displayLanguageMetrics(languageMetrics);
                }
                
                const recentResponse = await fetch(`${API_URL}/metrics/recent`);
                if (recentResponse.ok) {
                    const recentExecutions = await recentResponse.json();
                    displayRecentExecutions(recentExecutions);
                }
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }
        
        function displayOverallMetrics(metrics) {
            const statsHtml = `
                <div class="metric-row">
                    <div class="metric-label">Total Executions:</div>
                    <div class="metric-value">${metrics.total_executions}</div>
                </div>
                <div class="metric-row">
                    <div class="metric-label">Success Rate:</div>
                    <div class="metric-value">${(metrics.total_executions > 0 ? 
                        ((metrics.successful_executions / metrics.total_executions) * 100).toFixed(1) : 0)}%</div>
                </div>
                <div class="metric-row">
                    <div class="metric-label">Avg. Execution Time:</div>
                    <div class="metric-value">${metrics.avg_execution_time ? 
                        metrics.avg_execution_time.toFixed(3) : 0}s</div>
                </div>
                <div class="metric-row">
                    <div class="metric-label">Cold Starts:</div>
                    <div class="metric-value">${metrics.cold_starts}</div>
                </div>
                <div class="metric-row">
                    <div class="metric-label">Warm Starts:</div>
                    <div class="metric-value">${metrics.warm_starts}</div>
                </div>
            `;
            
            document.getElementById('overallStats').innerHTML = statsHtml;
        }
        
        function displayRuntimeMetrics(metrics) {
            let html = '<table class="metrics-table">';
            html += '<tr><th>Runtime</th><th>Count</th><th>Success</th><th>Avg Time</th></tr>';
            
            for (const [runtime, stats] of Object.entries(metrics)) {
                html += `
                    <tr>
                        <td>${runtime}</td>
                        <td>${stats.count}</td>
                        <td>${stats.success} (${stats.count > 0 ? ((stats.success / stats.count) * 100).toFixed(1) : 0}%)</td>
                        <td>${stats.avg_time ? stats.avg_time.toFixed(3) : 0}s</td>
                    </tr>
                `;
            }
            
            html += '</table>';
            document.getElementById('runtimeStats').innerHTML = html;
        }
        
        function displayLanguageMetrics(metrics) {
            let html = '<table class="metrics-table">';
            html += '<tr><th>Language</th><th>Count</th><th>Success</th><th>Avg Time</th></tr>';
            
            for (const [language, stats] of Object.entries(metrics)) {
                html += `
                    <tr>
                        <td>${language}</td>
                        <td>${stats.count}</td>
                        <td>${stats.success} (${stats.count > 0 ? ((stats.success / stats.count) * 100).toFixed(1) : 0}%)</td>
                        <td>${stats.avg_time ? stats.avg_time.toFixed(3) : 0}s</td>
                    </tr>
                `;
            }
            
            html += '</table>';
            document.getElementById('languageStats').innerHTML = html;
        }
        
        function displayRecentExecutions(executions) {
            if (executions.length === 0) {
                document.getElementById('recentExecutions').innerHTML = '<p>No execution records found</p>';
                return;
            }
            
            let html = '<table class="metrics-table">';
            html += '<tr><th>Time</th><th>Function</th><th>Runtime</th><th>Status</th><th>Execution Time</th></tr>';
            
            for (const exec of executions) {
                const timestamp = new Date(exec.timestamp * 1000).toLocaleString();
                const status = exec.status === 'success' ? 
                    '<span style="color: green;">Success</span>' : 
                    `<span style="color: red;">Error: ${exec.error || 'Unknown'}</span>`;
                
                html += `
                    <tr>
                        <td>${timestamp}</td>
                        <td>${exec.function_id || 'Ad-hoc'}</td>
                        <td>${exec.runtime || 'Unknown'}</td>
                        <td>${status}</td>
                        <td>${exec.execution_time ? exec.execution_time.toFixed(3) + 's' : 'N/A'}</td>
                    </tr>
                `;
            }
            
            html += '</table>';
            document.getElementById('recentExecutions').innerHTML = html;
        }
    </script>
</body>
</html>
